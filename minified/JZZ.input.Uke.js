!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t:"function"==typeof define&&define.amd?define("JZZ.input.Uke",["JZZ"],t):t(JZZ)}(function(h){if(h){h.input||(h.input={});for(var n="0.0.5",d=.04,v=.06,_=[.03,.01,-.01,-.03],l=[],t=0;t<25;t++)l.push(1-Math.pow(2,-t/12));var m,r=["C","C♯","D","E♭","E","F","F♯","G","A♭","A","B♭","B"],b="http://www.w3.org/2000/svg";c.prototype.create=function(){var t,e,n,a,u,r=function(t){var e,n,r,i=t.params.frets;(t=document.createElementNS(b,"svg")).setAttribute("version","1.1"),t.setAttribute("xmlns",b),t.setAttribute("viewBox",[-.25,-.2,.5,1.4].join(" "));var s=document.createElementNS(b,"g");for(t.appendChild(s),s.appendChild(y(-d,0,d,0)),s.appendChild(y(-v,1,v,1)),e=0;e<=i;e++)r=l[e],s.appendChild(y(-(n=d+(v-d)*r),r,n,r));for(s.appendChild(y(-d,0,-n,r)),s.appendChild(y(d,0,n,r)),4<i&&s.appendChild(A(0,(l[4]+l[5])/2)),6<i&&s.appendChild(A(0,(l[6]+l[7])/2)),9<i&&s.appendChild(A(0,(l[9]+l[10])/2)),11<i&&(s.appendChild(A(-.025,(l[11]+l[12])/2)),s.appendChild(A(.025,(l[11]+l[12])/2))),14<i&&s.appendChild(A(0,(l[14]+l[15])/2)),e=0;e<_.length;e++)s.appendChild(y(_[e],0,_[e]*v/d,1));return[t,s]}(this),i=r[0].createSVGPoint(),s=[],o=[],p=[],c=[];for(this._svg=r[0],this._svgg=r[1],this._xx=s,this._oo=o,this._ff=p,this._pp=c,this._playing=[],t=0;t<4;t++)s[t]=(n=e=void 0,e=document.createElementNS(b,"g"),n=.008,e.appendChild(y(-n,-n,n,n)),e.appendChild(y(-n,n,n,-n)),e.setAttribute("transform","translate(100,100)"),e),this._svgg.appendChild(s[t]);for(t=0;t<4;t++)o[t]=w("none"),this._svgg.appendChild(o[t]);for(t=0;t<4;t++)p[t]=w("black"),this._svgg.appendChild(p[t]);for(t=0;t<4;t++)c[t]=w("silver"),this._svgg.appendChild(c[t]);this.watchButtons=function(t){m=t.buttons},this.mouseUpHandle=I(this,i),this.mouseDownHandle=C(this,i),this.mouseMoveHandle=(a=this,u=i,function(t){if(x(t)){u.x=t.clientX,u.y=t.clientY;var e=u.matrixTransform(a._svgg.getScreenCTM().inverse());if(void 0!==a._nn){var n,r,i,s,o,e=g(e.x,e.y);if(e!=a._nn){for(e<a._nn&&(n=e,r=a._nn),e>a._nn&&(n=a._nn,r=e),s=n;s<r;s++)s!=a._ps&&(f=a._chord?a._chord[s]:0,"undefined"!=typeof f&&(o=f+a.params.strings[s],i=a.params.channels[s],a.forward(h.MIDI.noteOn(i,o)),setTimeout(k(a,i,o),200)));void 0!==a._ps&&(setTimeout(k(a,a.params.channels[a._ps],a._pn),200),a._ps=void 0,a._pn=void 0),a._nn=e}}}m=t.buttons}),this._svg.addEventListener("mousedown",this.mouseDownHandle),this._svg.addEventListener("mousemove",this.mouseMoveHandle),window.addEventListener("mousedown",this.watchButtons),window.addEventListener("mousemove",this.watchButtons),window.addEventListener("mouseup",this.mouseUpHandle),this.at=this.params.at,"string"==typeof this.at&&(this.at=document.getElementById(this.at));try{this.at.appendChild(this._svg)}catch(t){this.at=document.createElement("div"),document.body.appendChild(this.at),this.at.appendChild(this._svg)}},c.prototype._on=function(t,e){var n=e-this.params.strings[t];this._off(t),this._ss[t]=e,0<=n&&n<=this.params.frets&&(n=o(t,e=s(n)),this._pp[t].setAttribute("cx",n),this._pp[t].setAttribute("cy",e))},c.prototype._off=function(t){this._ss[t]=void 0,this._st[t]=void 0,this._pp[t].setAttribute("cx",100),this._pp[t].setAttribute("cy",100)},c.prototype.forward=function(t){for(var e,n=t[1],r=t.getChannel(),i=0;i<4;i++)r==this.params.channels[i]&&(e=i);0<=e&&e<=3&&(t.isNoteOn()?this._on(e,n):t.isNoteOff()&&this._off(e)),this.emit(t)},c.prototype.chord=function(t){if(void 0===t)return this._chord=void 0,void E(this);try{for(var e=[],n=0;n<4;n++){var r=parseInt(t[n]);r==t[n]&&0<=r&&r<=this.params.frets&&(e[n]=r)}this._chord=e,E(this)}catch(t){}},c.prototype.finger=function(t,e){var n;0<=t&&t<=4&&(this._chord||(this._chord=[0,0,0,0]),(n=parseInt(e))==e&&0<=n&&n<=this.params.frets&&(this._chord[t]=n))},c.prototype.svg=function(){return this.at.innerHTML},c.prototype.viewbox=function(t,e,n,r){this._svg.setAttribute("viewBox",[t,e,n,r].join(" "))},c.prototype.transform=function(t,e,n,r,i,s){this._svgg.setAttribute("transform","matrix("+[t,e,n,r,i,s].join(" ")+")")},c.prototype.destroy=function(){this.watchButtons&&(this._svg.removeEventListener("mousedown",this.mouseDownHandle),window.removeEventListener("mousedown",this.watchButtons),window.removeEventListener("mousemove",this.watchButtons),window.removeEventListener("mouseup",this.mouseUpHandle)),this.at.removeChild(this._svg)},M.prototype._info=function(t){return{type:"html/javascript",name:(e="Uke",t||e),manufacturer:"virtual",version:n};var e},M.prototype._openIn=function(e,t){var o=new c(this._arg);o.send=function(){e.send.apply(e,arguments)},o.emit=function(t){e._emit(t)},o.connect=function(){e.connect.apply(e,arguments)},o.create(),e._info=this._info(t),e._receive=function(t){o.forward(t)},e._close=function(){o.destroy()},e.svg=function(){return o.svg()},e.viewbox=function(t,e,n,r){return o.viewbox(t,e,n,r)},e.transform=function(t,e,n,r,i,s){return o.transform(t,e,n,r,i,s)},e.chord=function(t){o.chord(t)},e.finger=function(t,e){o.finger(t,e)},e._resume()},h.input.Uke=function(){var t,e;1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var n=new M;return n._arg=e,h.lib.openMidiIn(t,n)},h.input.Uke.version=function(){return n},h.input.Uke.register=function(){var t,e;1==arguments.length?"string"==typeof arguments[0]?t=arguments[0]:e=arguments[0]:(t=arguments[0],e=arguments[1]);var n=new M;return n._arg=e,h.lib.registerMidiIn(t,n)},h.input.Uke.strings=i,h.input.Uke.tuning=function(t){for(var e=[],n=0;n<4;n++)e.push(r[t[3-n]%12]);return t[3]>t[2]&&(e[0]=e[0].toLowerCase()),""+i(e=e.join("-"))==""+t?e:p(t)},h.input.Uke.tuningx=p}function s(t){return(l[t]+(t?l[t-1]:l[11]-l[12]))/2}function o(t,e){return _[t]*(1+e*(v/d-1))}function a(t,e){e=d*(1-e)+v*e;return e<t?-1:.5*e<t?0:0<t?1:.5*-e<t?2:-e<=t?3:-1}function g(t,e){e=.25*(d*(1-e)+v*e);return 3*e<t?0:e<t?1:-e<t?2:3*-e<t?3:4}function u(t){if(t){var e=t.split("-");return 4==e.length?e:(e=t.split("")).length<4?void 0:4==e.length?e:function t(e,n){if(!n)return e.length?void 0:[];for(var r=1;r<=e.length;r++){var i=e.substr(0,r);if(void 0===h.MIDI.noteValue(i+"9"))break;var s=t(e.substr(r),n-1);if(s)return[i].concat(s)}}(t,4)}}function i(t){var e,n,r=[];if(t=u(t)){for(e=0;e<4;e++){if(void 0===(n=h.MIDI.noteValue(t[3-e]))){if(e)return;break}r.push(n)}if(r.length)return r;for(e=0;e<4;e++){if(void 0===(n=h.MIDI.noteValue(t[e]+"9")))return;r.push(n%12)}for(e=1;e<4;e++)for(;r[e]<r[e-1];)r[e]+=12;var i=53;for(t[0][0]==t[0][0].toLowerCase()&&t[1][0]==t[1][0].toUpperCase()?(r[0]+=12,i=56):r[1]%12==9&&r[2]%12==2&&r[3]%12==7&&(i=33);r[1]<i;)for(e=0;e<4;e++)r[e]+=12;return r.reverse()}}function p(t){for(var e=[],n=0;n<4;n++)e.push(r[t[3-n]%12]+Math.floor(t[3-n]/12));return e.join("-")}function c(t){for(var e in this.params={frets:18,strings:i("gCEA"),channels:[0,1,2,3]},t=void 0===t?{}:t)this.params[e]=t[e];(this.params.frets!=parseInt(this.params.frets)||this.params.frets<1||24<this.params.frets)&&(this.params.frets=18),this._ss=[],this._st=[]}function y(t,e,n,r){var i=document.createElementNS(b,"line");return i.setAttribute("x1",t),i.setAttribute("y1",e),i.setAttribute("x2",n),i.setAttribute("y2",r),i.setAttribute("stroke","black"),i.setAttribute("vector-effect","non-scaling-stroke"),i.setAttribute("stroke-width","1px"),i}function A(t,e){var n=document.createElementNS(b,"circle");return n.setAttribute("cx",t),n.setAttribute("cy",e),n.setAttribute("r",.005),n.setAttribute("stroke","black"),n.setAttribute("fill","none"),n.setAttribute("vector-effect","non-scaling-stroke"),n.setAttribute("stroke-width","1px"),n}function w(t){var e=document.createElementNS(b,"circle");return e.setAttribute("cx",100),e.setAttribute("cy",100),e.setAttribute("r",.01),e.setAttribute("stroke","black"),e.setAttribute("fill",t),e.setAttribute("vector-effect","non-scaling-stroke"),e.setAttribute("stroke-width","1px"),e}function x(t){return void 0===t.buttons?!t.button:1&t.buttons}function C(i,s){return function(t){var e,n,r;x(t)&&(s.x=t.clientX,s.y=t.clientY,0<=(r=function(t){if(t<l[11]-l[12])return-1;for(var e=0;e<25;e++)if(t<=l[e])return e;return-1}((e=s.matrixTransform(i._svgg.getScreenCTM().inverse())).y))&&r<=i.params.frets?0<=(n=a(e.x,e.y))&&n<=3&&(i._ps=n,i._pn=r+i.params.strings[n],i.forward(h.MIDI.noteOn(i.params.channels[n],i._pn))):0<e.y&&e.y<1&&(0<=(n=a(e.x,e.y))&&n<=3&&(i._ps=n,r=i._chord&&i._chord[n]||0,i._pn=r+i.params.strings[n],i.forward(h.MIDI.noteOn(i.params.channels[n],i._pn))),i._nn=g(e.x,e.y))),m=t.buttons}}function k(t,e,n){return function(){t.forward(h.MIDI.noteOff(e,n))}}function I(n,r){return function(t){var e;t=void 0===(e=t).buttons||e.buttons!=m?e:(e.stopPropagation(),0==e.button?{buttons:1^m}:1==e.button?{buttons:4^m}:2==e.button?{buttons:2^m}:void 0),(void 0===(e=t).buttons?e.button:1&e.buttons)||(r.x=t.clientX,r.y=t.clientY,void 0!==n._ps&&(n.forward(h.MIDI.noteOff(n.params.channels[n._ps],n._pn)),n._ps=void 0,n._pn=void 0),n._nn=void 0),m=t.buttons}}function E(t){for(var e,n,r,i=0;i<4;i++)t._chord?(r=o(i,n=s(e=t._chord[i]||0)),e?(t._xx[i].setAttribute("transform","translate(100,100)"),t._oo[i].setAttribute("cx",100),t._oo[i].setAttribute("cy",100),t._ff[i].setAttribute("cx",r),t._ff[i].setAttribute("cy",n)):(void 0===t._chord[i]?(t._xx[i].setAttribute("transform","translate("+r+","+n+")"),t._oo[i].setAttribute("cx",100),t._oo[i].setAttribute("cy",100)):(t._xx[i].setAttribute("transform","translate(100,100)"),t._oo[i].setAttribute("cx",r),t._oo[i].setAttribute("cy",n)),t._ff[i].setAttribute("cx",100),t._ff[i].setAttribute("cy",100))):(t._xx[i].setAttribute("transform","translate(100,100)"),t._oo[i].setAttribute("cx",100),t._oo[i].setAttribute("cy",100),t._ff[i].setAttribute("cx",100),t._ff[i].setAttribute("cy",100))}function M(){}});